// Generated by CoffeeScript 1.4.0
(function() {
  var fs, list, sysPath, toHTML;

  sysPath = require("path");

  fs = require("fs");

  list = function(klass, links, pathname) {
    var link;
    return ((function() {
      var _i, _len, _results;
      _results = [];
      for (_i = 0, _len = links.length; _i < _len; _i++) {
        link = links[_i];
        _results.push("<a class='" + klass + "' href='" + (sysPath.join(pathname, link)) + "'>" + link + "</a>");
      }
      return _results;
    })()).join("\n");
  };

  toHTML = function(files, folders, pathname) {
    var prelink, prevpath;
    if (pathname !== "/") {
      prevpath = pathname.replace(/\/[\w-.$]*$/, "");
    }
    if ((prevpath != null) && prevpath.indexOf("/") === -1) {
      prevpath = "/" + prevpath;
    }
    prelink = prevpath != null ? "<a class='prevpath' href='" + prevpath + "' title='" + prevpath + "'>[上级目录]</a>" : "";
    return "<!DOCTYPE HTML>\n<html lang=\"en-US\">\n<head>\n  <meta charset=\"UTF-8\">\n  <title>Puer 目录浏览</title>\n  <link rel=\"stylesheet\" type=\"text/css\" href=\"/css/folder.css\">\n</head>\n<body>\n  <div class=\"g-doc\">\n    <h2>当前目录:<strong id=\"dir\">" + pathname + "</strong></h2>\n    " + prelink + "\n    " + (list('folder', folders, pathname)) + "\n    " + (list('file', files, pathname)) + "\n  </div>\n</body>\n</html> ";
  };

  module.exports = function(app, options) {
    return app.get(/(\/.*)/, function(req, res, next) {
      var path, pathname;
      pathname = req.params[0];
      path = sysPath.join(options.dir, pathname);
      return fs.stat(path, function(err, stats) {
        var files, folders;
        if ((err != null) || !stats.isDirectory()) {
          return next();
        }
        files = [];
        folders = [];
        return fs.readdir(path, function(err, subs) {
          var body;
          if (err != null) {
            return next();
          }
          subs.forEach(function(file) {
            var filepath;
            filepath = sysPath.join(path, file);
            if (fs.statSync(filepath).isFile()) {
              files.push(file);
            }
            if (fs.statSync(filepath).isDirectory()) {
              return folders.push(file);
            }
          });
          body = toHTML(files, folders, pathname);
          res.setHeader("Content-Type", "text/html");
          res.setHeader("Content-Length", Buffer.byteLength(body));
          return res.send(body);
        });
      });
    });
  };

}).call(this);
